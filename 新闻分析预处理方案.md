# 新闻分析预处理方案 - 强制新闻获取

## 📋 问题背景

### 现象
- ✅ **调试工具**可以成功获取到新闻（3条结果）
- ❌ **实际分析**时新闻栏目显示"数据暂时无法获取"

### 根本原因
调试工具和实际分析采用了**不同的新闻获取方式**：

| 对比项 | 调试工具 | 原实际分析流程 |
|--------|---------|---------------|
| 获取方式 | 直接调用统一新闻工具 | 依赖LLM调用工具 |
| 是否可靠 | ✅ 100%可靠 | ❌ 依赖LLM能力 |
| 数据保证 | ✅ 直接获取数据 | ❌ 可能不调用工具 |

## 🔧 解决方案

### 核心思路
**让实际分析也采用调试工具的方式：先强制获取新闻，再交给LLM分析**

### 实现细节

#### 1. 预处理新闻获取（对所有模型启用）

```python
# 🔧 改进方案：所有模型都预先强制获取新闻数据
pre_fetched_news = None
logger.info(f"[新闻分析师] 🚀 启动预处理：强制获取新闻数据（绕过LLM工具调用）...")
try:
    # 强制预先获取新闻数据（对所有模型启用，不依赖工具调用）
    logger.info(f"[新闻分析师] 🔧 预处理：强制调用统一新闻工具...")
    pre_fetched_news = unified_news_tool(stock_code=ticker, max_news=10, model_info=model_info)
```

#### 2. 数据验证（50字符阈值）

```python
# 🔧 修复：与统一新闻工具保持一致，使用50字符阈值
if pre_fetched_news and len(pre_fetched_news.strip()) > 50:
    logger.info(f"[新闻分析师] ✅ 预处理成功获取新闻: {len(pre_fetched_news)} 字符")
```

#### 3. 直接生成分析（跳过工具调用）

```python
# 直接基于预获取的新闻生成分析，跳过工具调用
enhanced_prompt = f"""
您是一位专业的财经新闻分析师。请基于以下已获取的最新新闻数据，对股票 {ticker} 进行详细分析：

=== 最新新闻数据 ===
{pre_fetched_news}

=== 分析要求 ===
{system_message}

请基于上述真实新闻数据撰写详细的中文分析报告。注意：新闻数据已经提供，您无需再调用任何工具。
"""

result = llm.invoke([{"role": "user", "content": enhanced_prompt}])
```

#### 4. 返回结果

```python
if hasattr(result, 'content') and result.content:
    report = result.content
    logger.info(f"[新闻分析师] ✅ 预处理模式成功，报告长度: {len(report)} 字符")
    
    # 返回分析报告
    return {
        "messages": [clean_message],
        "news_report": report,
    }
```

## 📊 新旧流程对比

### 旧流程（依赖LLM工具调用）

```
1. LLM接收提示："请调用工具获取新闻"
   ↓
2. LLM尝试调用工具（可能失败/不调用）
   ↓
3. 如果失败 → 无新闻数据 → 显示"数据暂时无法获取" ❌
```

### 新流程（预处理强制获取）

```
1. 代码直接调用统一新闻工具获取新闻 ✅
   ↓
2. 验证新闻数据（>50字符）
   ↓
3. 将新闻数据注入到LLM提示中
   ↓
4. LLM基于真实新闻数据生成分析报告 ✅
   ↓
5. 返回完整的新闻分析 ✅
```

## ✅ 优势

1. **可靠性**：100%保证能获取到新闻（只要API配置正确）
2. **一致性**：与调试工具完全相同的获取逻辑
3. **兼容性**：对所有LLM模型启用（不仅限于DashScope）
4. **回退机制**：如果预处理失败，仍会回退到标准模式
5. **详细日志**：完整的追踪日志，方便调试

## 📝 修改文件

- `tradingagents/agents/analysts/news_analyst.py`
  - 第 221-284 行：预处理新闻获取逻辑
  - 移除了对特定模型（DashScope）的限制
  - 对所有模型启用强制新闻获取

## 🧪 测试步骤

1. 部署到 Streamlit Cloud
2. 运行股票分析（如 002183）
3. 查看日志：
   ```
   [新闻分析师] 🚀 启动预处理：强制获取新闻数据
   [新闻分析师] ✅ 预处理成功获取新闻: XXX 字符
   [新闻分析师] ✅ 预处理模式成功，报告长度: XXX 字符
   ```
4. 确认新闻分析栏目显示正常

## 📌 注意事项

1. **前提条件**：Google Custom Search API 必须配置正确
2. **数据阈值**：新闻内容必须>50字符才会被接受
3. **错误处理**：如果预处理失败，会自动回退到标准模式（依赖LLM工具调用）
4. **日志追踪**：所有关键步骤都有详细日志记录

## 🎯 预期结果

- ✅ 调试工具能获取 → 实际分析也能获取
- ✅ 新闻分析栏目正常显示
- ✅ 完整的新闻分析报告
- ✅ 不再出现"数据暂时无法获取"提示

