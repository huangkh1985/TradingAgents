# 新闻数据流追踪调试

## 🔍 问题症状

- ✅ 调试工具能获取到 3 条新闻结果（Google Custom Search API 正常）
- ❌ 分析报告显示 "⚠️ 📰 新闻事件分析 数据暂时无法获取"

这说明新闻数据在**从获取到显示的某个环节丢失或变成了空**。

## 🐛 发现的Bug

### Bug 1: 判断逻辑错误

**位置**: `web/components/results_display.py` 第 445 行

**原代码**:
```python
if not value or (isinstance(value, str) and len(value.strip()) == 0):
```

**问题**: `not value` 对于某些非空字符串也可能返回错误结果

**修复**:
```python
if value is None or (isinstance(value, str) and len(value.strip()) == 0):
```

**改进**: 使用 `value is None` 更精确地判断空值

## 🔍 添加的调试追踪

### 1. 后端格式化阶段

**位置**: `web/utils/analysis_runner.py` `format_analysis_results()` 函数

**添加的日志**:
```python
if key == 'news_report':
    logger.info(f"[格式化结果] 📰 news_report 存在于 state 中")
    logger.info(f"[格式化结果] 类型: {type(content).__name__}, 长度: {len(str(content))}")
    logger.info(f"[格式化结果] 内容预览 (前200字符): {content[:200]}")
```

**目的**: 追踪新闻数据是否成功从分析结果传递到格式化环节

### 2. 前端显示阶段

**位置**: `web/components/results_display.py` `render_detailed_analysis()` 函数

**添加的日志**:
```python
logger.info(f"[显示调试] render_detailed_analysis 收到的 state 键: {list(state.keys())}")
if 'news_report' in state:
    logger.info(f"[显示调试] news_report 存在: 类型={type(news_value).__name__}, 长度={len(str(news_value))}")
    logger.info(f"[显示调试] news_report 内容预览 (前100字符): {news_value[:100]}")
```

**目的**: 确认前端接收到的数据是否完整

### 3. 空值替换阶段

**位置**: `web/components/results_display.py` 第 460 行

**添加的日志**:
```python
logger.debug(f"[显示调试] {module['key']}: {'为空，显示提示' if (条件) else f'有数据，长度={len(str(value))}'}")
```

**目的**: 记录哪些模块被替换为友好提示

## 📊 数据流追踪路径

```
1. 新闻分析师 (news_analyst.py)
   ↓ 返回: {"news_report": report}
   
2. 工作流图执行 (trading_graph.py)
   ↓ state["news_report"] = report
   
3. 异步执行器 (analysis_runner.py)
   ↓ raw_results = {"state": state, ...}
   
4. 格式化函数 (format_analysis_results)
   ↓ formatted_state["news_report"] = content
   🔍 日志检查点 1: 数据是否存在？
   
5. Session State (st.session_state.analysis_results)
   ↓ {'state': formatted_state}
   
6. 显示组件 (render_detailed_analysis)
   ↓ state = results['state']
   🔍 日志检查点 2: 前端收到什么？
   
7. 模块过滤 (available_modules)
   ↓ 检查是否为空
   🔍 日志检查点 3: 是否被替换？
   
8. 最终显示
   ✅ 或 ⚠️ 友好提示
```

## 🧪 调试步骤

### 1. 查看完整日志

在 Streamlit Cloud 或本地运行后，搜索以下关键词：

**新闻获取阶段**:
```
[新闻分析师] ✅ 返回清洁消息，报告长度: XXX 字符
[统一新闻工具] ✅ Google Custom Search API获取成功: XXX 字符
```

**格式化阶段**:
```
[格式化结果] 📰 news_report 存在于 state 中
[格式化结果] 类型: str, 长度: XXX
[格式化结果] 内容预览 (前200字符): ...
```

**显示阶段**:
```
[显示调试] render_detailed_analysis 收到的 state 键: [...]
[显示调试] news_report 存在: 类型=str, 长度=XXX
[显示调试] news_report 内容预览 (前100字符): ...
```

**替换检查**:
```
[显示调试] news_report: 有数据，长度=XXX
或
[显示调试] news_report: 为空，显示提示
```

### 2. 诊断问题

根据日志输出判断：

#### 情况 1: 获取阶段失败
```
❌ [统一新闻工具] ⚠️ Google Custom Search API返回空内容
```
**原因**: API 未配置或失败  
**解决**: 检查 Google Custom Search API 配置

#### 情况 2: 格式化阶段丢失
```
✅ [新闻分析师] ✅ 返回清洁消息，报告长度: 500 字符
❌ [格式化结果] ⚠️ news_report 不存在于 state 中
```
**原因**: state 传递问题  
**解决**: 检查工作流图返回值

#### 情况 3: 显示阶段丢失
```
✅ [格式化结果] 📰 news_report 存在，长度: 500
❌ [显示调试] ⚠️ news_report 不在 state 中
```
**原因**: Session State 传递问题  
**解决**: 检查 `st.session_state.analysis_results` 结构

#### 情况 4: 被错误替换
```
✅ [显示调试] news_report 存在，长度: 500
❌ [显示调试] news_report: 为空，显示提示
```
**原因**: 判断逻辑错误（已修复）  
**解决**: 已更新为 `value is None`

## ✅ 修复文件

1. ✅ `web/components/results_display.py`
   - 修复空值判断逻辑: `not value` → `value is None`
   - 添加详细调试日志

2. ✅ `web/utils/analysis_runner.py`
   - 添加格式化阶段调试日志
   - 追踪 news_report 数据流

## 🎯 预期效果

修复后，通过日志可以清晰看到：
1. ✅ 新闻在哪个阶段获取成功（长度多少）
2. ✅ 数据在哪个环节传递（格式化/显示）
3. ✅ 是否被错误判断为空并替换
4. ✅ 最终显示的是真实数据还是友好提示

## 📝 使用调试功能

### 启用调试模式

在分析报告页面：
1. 勾选 "🔍 显示调试信息"
2. 查看实际的 state 键列表
3. 查看各键的数据类型和内容预览

### 查看日志

在 Streamlit Cloud:
1. 点击右上角 "⋮" → "Settings" → "View logs"
2. 搜索 `[显示调试]` 或 `[格式化结果]`
3. 分析数据流动路径

---

**创建时间**: 2025-10-06  
**目的**: 追踪新闻数据从获取到显示的完整流程
**状态**: 调试日志已添加，等待实际测试验证

