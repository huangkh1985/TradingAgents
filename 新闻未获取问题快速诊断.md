# 新闻未获取问题 - 快速诊断指南

## 🔍 当前情况

**症状**：选择新闻分析师后，所有分析报告都显示"⚠️ 数据暂时无法获取"

**调试信息显示**：
- ✅ `news_report` 键存在于 state 中
- ❌ 但内容只有 135 字符（友好提示信息）
- ✅ 后续决策报告（risk_assessment等）有内容

**结论**：不是数据传递问题，而是**分析师根本没有生成有效内容**

## 🎯 可能的原因（按概率排序）

### 原因 1: LLM 模型不支持工具调用（90%可能）

**症状**：
- 所有需要调用工具的分析师（市场、新闻、基本面、情绪）都返回空内容
- 不需要工具的分析师（决策团队）有内容
- 日志显示"LLM调用了 0 个工具"

**常见模型**：
- ❌ 某些 DeepSeek 版本
- ❌ 部分 OpenAI 兼容 API
- ❌ 自部署的本地模型

**解决方案**：
1. 检查使用的 LLM 提供商和模型
2. 切换到支持工具调用的模型（如 OpenAI gpt-4、gpt-3.5-turbo）
3. 或确保补救机制正常工作

### 原因 2: API 密钥配置错误（5%可能）

**症状**：
- LLM 调用失败
- 日志显示认证错误

**解决方案**：
检查 Streamlit Secrets 中的配置：
```toml
[llm]
OPENAI_API_KEY = "sk-..."
# 或
DEEPSEEK_API_KEY = "sk-..."
```

### 原因 3: 补救机制被跳过（5%可能）

**症状**：
- 日志显示"没有调用任何工具"
- 但没有"启动补救机制"的日志

**原因**：代码逻辑错误或异常被捕获

## 🧪 快速测试方案

### 步骤 1: 检查使用的模型

在 Streamlit Cloud 日志中搜索：
```
llm_provider
使用模型
```

**期望看到**：
```
llm_provider: openai
model: gpt-3.5-turbo
```

**如果看到其他模型**，可能不支持工具调用。

### 步骤 2: 检查工具调用情况

搜索：
```
[新闻分析师] LLM调用了
```

**正常情况**：
```
[新闻分析师] LLM调用了 1 个工具
```

**异常情况**：
```
[新闻分析师] LLM调用了 0 个工具
[新闻分析师] ⚠️ ChatXXX 没有调用任何工具，启动补救机制...
```

### 步骤 3: 检查补救机制

搜索：
```
[新闻分析师] 🔧 强制调用统一新闻工具
```

**期望看到**：
```
[新闻分析师] 🔧 强制调用统一新闻工具获取新闻数据...
[统一新闻工具] 尝试Google Custom Search API...
[Google Custom Search] 获取到 3 条结果，耗时 1.23 秒
[统一新闻工具] ✅ Google Custom Search API获取成功: 687 字符
[新闻分析师] ✅ 强制获取新闻成功: 687 字符
```

**如果看到**：
```
[新闻分析师] ⚠️ 统一新闻工具获取失败，使用原始结果
```

说明新闻获取也失败了。

### 步骤 4: 检查最终返回

搜索：
```
[新闻分析师] 🔍 最终返回的report长度
```

**期望看到**：
```
[新闻分析师] 🔍 最终返回的report长度: 1234
[新闻分析师] 🔍 最终返回内容预览(前300字符): ## 📰 新闻分析报告...
```

**如果看到**：
```
[新闻分析师] 🔍 最终返回的report长度: 0
[新闻分析师] ❌ 警告：返回的report为空！
```

说明整个流程失败了。

## 💡 临时解决方案

### 方案 1: 切换到 OpenAI（推荐）

在 Streamlit Cloud Secrets 中配置：
```toml
[llm]
OPENAI_API_KEY = "sk-proj-..."
OPENAI_API_BASE = "https://api.openai.com/v1"
```

然后在侧边栏选择：
- LLM 提供商：OpenAI
- 模型：gpt-3.5-turbo 或 gpt-4

### 方案 2: 使用兼容的 DeepSeek 模型

确保使用支持工具调用的版本：
```toml
[llm]
DEEPSEEK_API_KEY = "sk-..."
```

选择模型：`deepseek-chat`（确保是最新版本）

### 方案 3: 强制启用补救机制

如果模型确实不支持工具调用，可以修改代码强制使用补救：

在 `tradingagents/agents/analysts/news_analyst.py` 中，将：
```python
if tool_call_count == 0:
```

改为：
```python
if True:  # 强制使用补救机制
```

这样会跳过工具调用，直接强制获取新闻。

## 📋 诊断检查清单

请按顺序检查并告诉我结果：

- [ ] 1. 使用的 LLM 提供商是什么？（OpenAI / DeepSeek / 其他）
- [ ] 2. 使用的模型名称是什么？（gpt-3.5-turbo / deepseek-chat / 其他）
- [ ] 3. 日志中"LLM调用了 X 个工具"，X 是多少？
- [ ] 4. 是否看到"启动补救机制"的日志？
- [ ] 5. 是否看到"强制获取新闻成功"的日志？
- [ ] 6. "最终返回的report长度"是多少？

## 🔧 最快的解决方法

**如果您急需解决**，最快的方法是：

1. **配置 OpenAI API**（推荐）
   ```toml
   [llm]
   OPENAI_API_KEY = "sk-proj-..."
   ```

2. **或使用 OpenAI 兼容代理**
   ```toml
   [llm]
   OPENAI_API_KEY = "sk-..."
   OPENAI_API_BASE = "https://api.deepseek.com/v1"  # DeepSeek 兼容
   ```

3. **在侧边栏选择**
   - LLM提供商：OpenAI
   - 模型：gpt-3.5-turbo

这样可以确保工具调用正常工作。

---

**请告诉我上述检查清单的结果，我会提供精确的解决方案！** 🎯

