# 新闻分析报告不显示问题诊断

## 🔍 问题描述

在新版本的分析报告中，**连"新闻分析"这个栏目标题都没有了**，而旧版本中有显示。

## 🧪 诊断步骤

### 步骤 1: 启用调试模式查看状态

在分析完成后，在"详细分析报告"下方：
1. 勾选 **"🔍 显示调试信息"** 复选框
2. 查看 **"实际状态中的键"** 列表
3. 检查是否包含 `news_report`

**预期结果**：
- ✅ 如果列表中有 `news_report`，说明新闻数据已生成
- ❌ 如果没有，说明新闻分析师没有返回数据

### 步骤 2: 检查新闻报告内容

如果看到 `news_report` 键：
1. 查看其数据类型和内容预览
2. 检查字符数是否大于 0

**可能的问题**：
- 内容为空字符串 `""`
- 内容过短被过滤

### 步骤 3: 查看后台日志

在 Streamlit Cloud 或本地运行时，查看日志输出：

搜索关键词：
```
[新闻分析师]
[统一新闻工具]
[Google Custom Search]
```

**关键日志**：
```
[新闻分析师] ✅ 返回清洁消息，报告长度: XXX 字符
[统一新闻工具] ✅ Google Custom Search API获取成功: XXX 字符
```

## 🔧 可能的原因和解决方案

### 原因 1: 长度阈值过严（已修复）

**问题**：新闻内容被判定为"过短"而被过滤

**已修复内容**：
- ✅ `tradingagents/tools/unified_news_tool.py` - 所有阈值从 100→50
- ✅ `tradingagents/agents/analysts/news_analyst.py` - 补救机制阈值从 100→50

**验证**：重新运行分析，检查日志是否显示"获取成功"

### 原因 2: 报告内容为空

**症状**：
```
news_report: str (0 字符) - 
```

**可能原因**：
1. Google Custom Search API 未配置或配额用完
2. 所有新闻源都失败
3. 新闻获取逻辑出错

**解决方案**：
1. 检查 Streamlit Secrets 中 Google Search API 配置
2. 运行调试工具测试 API
3. 查看详细错误日志

### 原因 3: 前端过滤逻辑

**位置**：`web/components/results_display.py` 第 429-441 行

**逻辑**：
```python
# 只显示有数据的模块
if module['key'] in state and state[module['key']]:
    available_modules.append(module)
```

**问题**：
- 如果 `state['news_report']` 为空字符串 `""`，会被判定为假值而不显示
- 如果 `state` 中根本没有 `news_report` 键，也不会显示

## 🛠️ 临时修复方案

### 方案 1: 修改过滤逻辑（推荐）

修改 `web/components/results_display.py`：

```python
# 过滤出有数据的模块
available_modules = []
for module in analysis_modules:
    if module['key'] in state:  # 只检查键是否存在
        value = state[module['key']]
        # 🔧 修复：允许空字符串，以便显示"暂无数据"提示
        if value or value == "":  # 即使为空也显示
            available_modules.append(module)
            if not value:  # 如果为空，添加占位内容
                state[module['key']] = "⚠️ 暂无新闻数据，请检查API配置"
```

### 方案 2: 强制显示新闻模块

在 `web/components/results_display.py` 中强制添加新闻模块：

```python
# 确保新闻模块始终显示（如果在分析师列表中）
analysts = results.get('analysts', [])
if 'news' in analysts:
    if 'news_report' not in state or not state['news_report']:
        state['news_report'] = """
        ⚠️ 新闻数据获取失败
        
        可能原因：
        1. Google Custom Search API 未配置
        2. API 配额已用完
        3. 新闻源暂时不可用
        
        请检查配置或稍后重试。
        """
```

## 📝 完整诊断命令

### 1. 检查配置

```python
# 在 Python 脚本中
import streamlit as st

# 检查 Secrets
if hasattr(st, 'secrets') and 'google_search' in st.secrets:
    api_key = st.secrets['google_search'].get('API_KEY')
    cx = st.secrets['google_search'].get('CX')
    print(f"API_KEY配置: {'✅' if api_key else '❌'}")
    print(f"CX配置: {'✅' if cx else '❌'}")
```

### 2. 测试新闻获取

```python
# 运行测试脚本
python scripts/test_news_fix.py
```

### 3. 查看实际返回数据

在 `web/utils/analysis_runner.py` 的 `format_analysis_results` 函数中添加调试：

```python
# 第 733 行附近
for key in analysis_keys:
    if key in state:
        content = state[key]
        print(f"🔍 [格式化] {key}: {type(content).__name__}, 长度: {len(str(content))}")
        if isinstance(content, str):
            content = translate_analyst_labels(content)
        formatted_state[key] = content
    else:
        print(f"⚠️ [格式化] {key}: 不存在于 state 中")
```

## ✅ 验证修复

修复后，验证步骤：
1. ✅ 启用调试信息，确认 `news_report` 在状态键列表中
2. ✅ 确认报告内容长度 > 0
3. ✅ 确认"📰 新闻事件分析"标签页出现
4. ✅ 点击标签页，查看新闻内容

## 🎯 预期效果

修复后应该看到：
- ✅ 新闻分析标签页始终显示（如果选择了新闻分析师）
- ✅ 如果获取成功，显示新闻内容
- ✅ 如果获取失败，显示友好的错误提示
- ✅ 不再出现"整个栏目消失"的情况

---

**诊断工具**：使用调试复选框和日志输出
**修复时间**：2025-10-06
**版本**：新闻显示问题修复

